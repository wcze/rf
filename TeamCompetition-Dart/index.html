<!DOCTYPE html>
<html lang="en">

<script>
    const fish_data = ["C2超级怪胎", "丁克斯带形鲤", "丁克斯无鳞鲤", "丁克斯镜鲤", "丁鱥", "三刺鱼", "三花鲤鱼", "上口欧鳊", "东方欧鳊", "东西伯利亚茴鱼", "东西伯利亚鲟", "乌克兰七鳃鳗", "九棘刺", "亚口鱼", "亚洲胡瓜鱼", "亚速海拟鲤", "伊氏狼绵鳚", "俄罗斯梭吻鲈", "俄罗斯鲟", "内维红点鲑", "冰岛海扇蛤", "剑鱼", "勃氏西鲱", "匈红鲤（镜鲤）", "匈红鲤(鳞鲤)", "北大西洋长尾鳕", "北方蓝鳍金枪鱼", "北极红点鲑", "北极茴鱼", "北海平鲉", "半裸狼绵鳚", "单鳍鳕", "叉牙楔齿七鳃鳗", "哲罗鱼", "四白锦鲤", "图们江细鳞鲑", "图冈白鲑", "圆点五色锦鲤", "圆腹雅罗鱼", "圆鳍鱼", "堪察加虹鳟", "塞凡湖鳟", "多指鞭冠𩽾𩾌", "大口水牛鱼", "大菱鲆", "大西洋狼鳚", "大西洋银鲛", "大西洋鲑鱼", "大西洋鲭", "大西洋鲱", "大西洋鳕", "大鳞麻哈鱼", "大麻哈鱼", "大鼻软口鱼", "姥鲨", "宽鼻白鲑", "小体鲟", "小头睡鲨", "小白鮭", "小齿狼鱼", "尖吻平鲉", "帝王蟹", "带形镜鲤", "带形镜鲤(人面鲤)", "带形镜鲤(白化)", "常见拟鲤", "常见狗鱼", "常见鮈鱼", "常见鲃鱼", "平腹多刺魚", "库图拟鲤", "库尔斯多夫丁鱥", "庸鲽", "廓里湖白鲑", "廓里湖红点鲑", "拉多加湖湖泊白鲑", "拉多加白鲑", "拉多加鲑", "拉多加鲟", "拟鲌", "文鳊", "斑点月鱼", "斯维里河白鲑", "无鳞鲤", "无鳞鲤 （人面鲤）", "无鳞鲤（白化）", "普通鲤鱼", "极北鳐", "框形镜鲤", "框形镜鲤（人面鲤）", "框形镜鲤（白化）", "梅花鲈", "梭鲈鱼", "棱鲱", "橙黄金锦鲤", "欧洲六须鲇", "欧洲康吉鳗", "欧洲无须鳕", "欧洲鱿鱼", "欧洲鳇", "欧白鲑", "欧飘鱼", "欧鲌", "欧鳊", "武克希白鲑", "江鳕", "沃尔霍夫白鲑", "沙丁鱼", "河斑马纹贻贝", "河螯虾", "波斯鲟", "波罗的海鲟鱼", "泥鳅", "海平鲉", "湖大吻鱥", "湖拟鲤", "湖鱥", "湖鳟鱼", "牙鳕", "牡蛎", "犬首鮈", "珠星三块鱼", "珠蚌", "瓦拉姆白鲑", "白化鲃鱼", "白化鲇鱼", "白北鲑", "白斑红点鲑", "白斑角鲨", "白眼欧鳊", "白鲑鱼", "皱鳃鲨", "真柱白鲑", "短头梭鲃", "短角大杜父鱼", "石斑鱼", "秋白鲑", "穆松白鲑", "竹刀鱼", "粉鲑", "粗壮红点鲑", "红大麻哈鱼", "红白锦鲤", "红鳍鱼", "细鳞鲑", "绯写锦鲤", "绵鳚", "绿青鳕", "美洲红点鲑", "胡瓜鱼", "花狼鱼", "花羔红点斑鲑", "花鲶", "茴鱼", "草鱼", "莱文氏红点鲑", "莱芒湖白鲑", "葛氏鲈塘鳢", "董氏须鳅", "蒙古红鲌", "蓝魣鳕", "蓝鳕", "虹鳟", "裸腹鲟", "西伯利亚小体鲟", "西伯利亚杜父鱼", "诸子鲦", "贝加尔白鲑", "贝加尔雅罗鱼", "贻贝", "赤梢鱼", "达氏鳇", "里海七鳃鳗", "里海拟鲤", "里海西鲱", "里海鲑鱼", "金丁鱥", "金鲫", "钓𩽾𩾌", "钝头鳐", "银鲫", "银鲷鱼", "银鳟鱼", "镜鲤", "镜鲤（人面鲤）", "镜鲤（白化）", "长体西鲱", "长吻梅花鲈", "长吻黄盖鲽", "长拟庸鲽", "闪光鲟", "雅罗鱼", "雷氏七鳃鳗", "青蛙", "青鳕", "食用蟹", "马舌鲽", "马苏大麻哈鱼", "马苏鱼", "驼背太阳鱼", "驼背白鲑", "高白鲑", "魣鳕", "鲈鱼", "鲢鱼", "鲤鲫", "鲽鱼", "鳗鱼", "鳙鱼", "鳞鲤(人面鲤)", "鳞鲤(白化)", "鳟鱼", "鸣海浅黄锦鲤", "黄斑红点鲑", "黑口红点鲑", "黑尾叉牙七鳃鳗", "黑库图拟鲤", "黑海欧洲鰉", "黑海欧白鱼", "黑牛胭脂鱼", "黑白鲑", "黑线鳕", "黑背西鲱", "黑长鲳", "黑鲩", "鼠鲨"];
</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Competition Dart</title>
    <link rel="icon" href="./icon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        input {
            background: none;
            border: none;
            font-size: 16px;
            width: 100%;
            height: 1.6em;
        }

        th>input {
            font-weight: bold;
        }

        input:focus {
            background-color: #ffffff;
        }

        .select2-container {
            width: 100% !important;
        }

        .select2-selection {
            border: none !important;
            background: none !important;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #dataWeight {
            width: 100%;
            border-top: 2px dashed #999;
            margin-top: 20px;
        }

        .weightBar {
            width: 100%;
            height: 60px;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            overflow: hidden;
        }

        .weightBar>div {
            padding: 0 20px;
            height: 100%;
            text-align: center;
            color: white;
            line-height: 60px;
            min-width: fit-content;
            display: flex !important;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: width 0.5s ease;
        }

        .weightBar>div>div {
            line-height: 1.5em;
            font-weight: bold;
        }

        #title-shot {
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>

<body>
    <div id="content">
        <input type="text" id="title" value="" placeholder="标题"
            style="width: 100%; font-size: 36px; font-weight: bold; padding: 8px;text-align: center;">
        <h1 id="title-shot"></h1>
        <table>
            <thead>
                <tr>
                    <th width="300">鱼种</th>
                    <th>目标值</th>
                    <th>差异值</th>
                    <th>
                        <input type="text" value="" placeholder="点击输入ID">
                    </th>
                    <th>
                        <input type="text" value="" placeholder="点击输入ID">
                    </th>
                    <th>
                        <input type="text" value="" placeholder="点击输入ID">
                    </th>
                    <th>
                        <input type="text" value="" placeholder="点击输入ID">
                    </th>
                    <th>
                        <input type="text" value="" placeholder="点击输入ID">
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <select class="searchable-select"></select>
                    </td>
                    <td><input type="text" value="" class="targetValue"></td>
                    <td><input type="text" value="" class="varianceValue" disabled></td>
                    <td><input type="text" value="" class="v-1"></td>
                    <td><input type="text" value="" class="v-1"></td>
                    <td><input type="text" value="" class="v-1"></td>
                    <td><input type="text" value="" class="v-1"></td>
                    <td><input type="text" value="" class="v-1"></td>
                </tr>
                <tr>
                    <td>
                        <select class="searchable-select"></select>
                    </td>
                    <td><input type="text" value="" class="targetValue"></td>
                    <td><input type="text" value="" class="varianceValue" disabled></td>
                    <td><input type="text" value="" class="v-2"></td>
                    <td><input type="text" value="" class="v-2"></td>
                    <td><input type="text" value="" class="v-2"></td>
                    <td><input type="text" value="" class="v-2"></td>
                    <td><input type="text" value="" class="v-2"></td>
                </tr>
                <tr>
                    <td>
                        <select class="searchable-select"></select>
                    </td>
                    <td><input type="text" value="" class="targetValue"></td>
                    <td><input type="text" value="" class="varianceValue" disabled></td>
                    <td><input type="text" value="" class="v-3"></td>
                    <td><input type="text" value="" class="v-3"></td>
                    <td><input type="text" value="" class="v-3"></td>
                    <td><input type="text" value="" class="v-3"></td>
                    <td><input type="text" value="" class="v-3"></td>
                </tr>
                <tr>
                    <td>
                        <select class="searchable-select"></select>
                    </td>
                    <td><input type="text" value="" class="targetValue"></td>
                    <td><input type="text" value="" class="varianceValue" disabled></td>
                    <td><input type="text" value="" class="v-4"></td>
                    <td><input type="text" value="" class="v-4"></td>
                    <td><input type="text" value="" class="v-4"></td>
                    <td><input type="text" value="" class="v-4"></td>
                    <td><input type="text" value="" class="v-4"></td>
                </tr>
                <tr>
                    <td>
                        <center><b>总计</b></center>
                    </td>
                    <td><input type="text" value="" class="targetValueSum" disabled></td>
                    <td><input type="text" value="" class="varianceValueSum" disabled></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div style="margin-top: 20px; text-align: right;">
        <button id="clearData">🗑 清除数据</button>
        <button id="screenShot">🖨 页面截图</button>
    </div>

    <div id="dataWeight" style="display: none;">
        <h3>目标值权重比：</h3>
        <div id="dataWeight-weightBar" class="weightBar">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>

        $('#screenShot').click(function () {
            $('#title-shot').text($('#title').val());
            $('#title-shot').show();
            $('#title').hide();
            $('#content').css('padding', '20px');
            setTimeout(() => {
                html2canvas(document.querySelector('#content')).then((canvas) => {
                    const imageDataURL = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = imageDataURL;
                    a.download = $('#title').val() + '.png';
                    a.click();
                });

                $('#title-shot').hide();
                $('#title').show();
                $('#content').css('padding', '0');
            }, 100);
        });

        function dataWeight() {
            if ($('.searchable-select').filter(function () { return this.value; }).length < 4 ||
                $('.targetValue').filter(function () { return this.value; }).length < 4) {
                $('#dataWeight').hide();
                return;
            }
            $('#dataWeight').show();
            dataWeight_weightBar();



            function dataWeight_weightBar() {
                let totalWeight = 0;
                let fishWeights = [];

                $('.searchable-select').each(function (index) {
                    const fish = $(this).val();
                    const weight = parseFloat($('.targetValue').eq(index).val());
                    if (fish && !isNaN(weight)) {
                        totalWeight += weight;
                        fishWeights.push({ fish, weight });
                    }
                });

                const colors = ['#007bff', '#28a745', '#edb40c', '#dc3545'];
                $('#dataWeight-weightBar > div').each(function (index) {
                    const fishWeight = fishWeights[index];
                    if (fishWeight) {
                        const percentage = (fishWeight.weight / totalWeight) * 100;
                        $(this).css({
                            'width': `${percentage}%`,
                            'background-color': colors[index % colors.length]
                        }).html(`
                        <div>${fishWeight.fish}</div>
                        <div>${percentage.toFixed(2)} %</div>
                    `);
                    } else {
                        $(this).css({
                            'width': '0',
                            'background-color': 'transparent'
                        }).html('');
                    }
                });
            }
        }



        function updateSums() {
            let targetSum = 0;
            let varianceSum = 0;

            $('.targetValue').each(function () {
                const value = parseFloat($(this).val());
                if (!isNaN(value)) {
                    targetSum += value;
                }
            });

            $('.varianceValue').each(function () {
                const value = parseFloat($(this).val());
                if (!isNaN(value)) {
                    varianceSum += value;
                }
            });

            $('.targetValueSum').val(targetSum);
            $('.varianceValueSum').val(varianceSum);
        }

        $(document).ready(function () {
            const fishOptions = fish_data.map(fish => `<option value="${fish}">${fish}</option>`).join('');
            $('.searchable-select').append(`<option value="">选择鱼种</option>${fishOptions}`).select2();

            function updateTable() {
                $('tbody tr').each(function () {
                    const targetValue = parseFloat($(this).find('.targetValue').val());
                    if (!isNaN(targetValue)) {
                        let closestValue = null;
                        let closestDifference = Infinity;
                        let closestInput = null;

                        $(this).find('input[class^="v-"]').each(function () {
                            const playerValue = parseFloat($(this).val());
                            if (!isNaN(playerValue)) {
                                const difference = Math.abs(playerValue - targetValue);
                                if (difference < closestDifference) {
                                    closestDifference = difference;
                                    closestValue = playerValue;
                                    closestInput = $(this);
                                }
                            }
                        });

                        $(this).find('input[class^="v-"]').css('color', '#000000');
                        $(this).find('input[class^="v-"]').css('font-weight', 'normal');
                        if (closestInput) {
                            closestInput.css('color', '#2941ff');
                            closestInput.css('font-weight', 'bold');
                        }

                        $(this).find('.varianceValue').val(closestDifference !== Infinity ? closestDifference : targetValue);
                    } else {
                        $(this).find('.varianceValue').val('');
                    }
                });
            }

            function saveData() {
                const data = getInputsAsArray();
                localStorage.setItem('tableData', data);
            }

            function getInputsAsArray() {
                const data = [];
                const input = [];
                const select = [];
                $('input').each(function () {
                    input.push($(this).val());
                });
                $('select').each(function () {
                    select.push($(this).val());
                });
                data.push(input, select);
                return JSON.stringify(data);
            }

            function loadData() {
                const data = JSON.parse(localStorage.getItem('tableData'));
                if (data) {
                    const [input, select] = data;
                    $('input').each(function (index) {
                        $(this).val(input[index]);
                    });
                    $('select').each(function (index) {
                        $(this).val(select[index]).trigger('change');
                    });
                }
            }

            $('input').on('input', function () {
                updateTable();
                updateSums();
                saveData();
                dataWeight();
            });

            $('select').on('change', function () {
                saveData();
                dataWeight();
            });

            $('input[class^="v-"]').on('click', function () {
                this.select();
                this.setSelectionRange(0, this.value.length);
                document.execCommand('selectAll');
            });

            $('#clearData').on('click', function () {
                $('input').each(function () {
                    $(this).not('[placeholder="点击输入ID"]').val('');
                });
                $('.searchable-select').val('').trigger('change');
                updateTable();
                updateSums();
                saveData();
            });

            loadData();
            updateTable();
            updateSums();
        });
    </script>
</body>

</html>